{% extends 'html/base.html.twig' %}

{% block content %}
    <div class="w-full p-4 bg-white border border-gray-200 rounded-lg shadow sm:p-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h5 class="text-xl font-bold leading-none text-gray-900">{{ "Run Letters"|trans }}</h5>
                <p class="text-sm text-gray-500 mt-1">{{ "A record of showing up"|trans }}</p>
            </div>
            <div class="text-sm font-medium text-gray-900">
                <div class="flex flex-col items-end gap-y-1">
                    <span class="text-2xl font-bold text-strava-orange">{{ currentStreak }}</span>
                    <span class="text-xs text-gray-500">{{ "day streak"|trans }}</span>
                </div>
            </div>
        </div>

        {% if totalLetters > 0 %}
            <div class="flow-root">
                <ul role="list" class="divide-y divide-gray-200">
                    {% for item in enrichedLetters %}
                        {% set letter = item.letter %}
                        {% set activity = item.activity %}
                        <li class="py-5 hover:bg-gray-50 transition-colors rounded-lg px-3 -mx-3">
                            <div class="flex flex-col gap-y-3">
                                <!-- Header: Date and activity info -->
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-x-3">
                                        <div class="flex-shrink-0">
                                            <svg class="w-8 h-8 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                                            </svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">
                                                {{ activity.getStartDate().formatLocalized('%B %e, %Y') }}
                                            </p>
                                            <p class="text-sm text-gray-500 truncate">
                                                {{ activity.getDistanceInKilometer().getFormatted() }} &middot; {{ activity.getFormattedMovingTime() }} &middot; {{ activity.getSportType() }}
                                            </p>
                                        </div>
                                    </div>
                                    {% if letter.isPublic() %}
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            {{ "Public"|trans }}
                                        </span>
                                    {% endif %}
                                </div>

                                <!-- Letter content -->
                                <div class="letter-content-{{ activity.getId() }} text-base text-gray-700 leading-relaxed italic border-l-4 border-gray-300 pl-4">
                                    "<span class="letter-text">{{ letter.getLetterText() }}</span>"
                                </div>

                                <!-- Edit/Share Actions -->
                                <div class="flex items-center gap-x-2">
                                    <button onclick="editLetter('{{ activity.getId() }}')"
                                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                        <svg class="w-3 h-3 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                                        </svg>
                                        {{ "Edit"|trans }}
                                    </button>
                                    <button onclick="togglePublic('{{ activity.getId() }}')"
                                            class="public-toggle-{{ activity.getId() }} inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                        <svg class="w-3 h-3 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z"/>
                                        </svg>
                                        {{ letter.isPublic() ? "Make Private"|trans : "Make Public"|trans }}
                                    </button>
                                    {% if letter.isPublic() and letter.getShareToken() %}
                                        <button onclick="copyShareLink('{{ letter.getShareToken() }}')"
                                                class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white bg-strava-orange border border-transparent rounded-md hover:bg-orange-600">
                                            <svg class="w-3 h-3 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244"/>
                                            </svg>
                                            {{ "Copy Link"|trans }}
                                        </button>
                                    {% endif %}
                                </div>

                                <!-- Metadata footer -->
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <div class="flex items-center gap-x-3">
                                        {% if letter.wasEdited() %}
                                            <span class="flex items-center gap-x-1">
                                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                                                </svg>
                                                {{ "Edited"|trans }}
                                            </span>
                                        {% else %}
                                            <span class="flex items-center gap-x-1">
                                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904 9 18.75l2.846-.81-2.033-2.036zm5.107-2.997-2.033-2.036L18.309 5.45l2.033 2.036-5.422 5.421z"/>
                                                </svg>
                                                {{ "AI Generated"|trans }}
                                            </span>
                                        {% endif %}
                                        <span>{{ letter.getGeneratedAt().formatLocalized('%b %e, %Y') }}</span>
                                    </div>
                                    <div>
                                        <a href="{{ relativeUrl('activity/' ~ activity.getId() ~ '.html') }}"
                                           data-router-navigate="{{ relativeUrl('activity/' ~ activity.getId() ~ '.html') }}"
                                           class="text-strava-orange hover:underline">
                                            {{ "View activity"|trans }} â†’
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% else %}
            <div class="text-center py-12 px-4">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <h3 class="text-2xl font-bold text-gray-900 mb-3">{{ "Welcome to Run Letters"|trans }}</h3>
                <p class="text-base text-gray-700 mb-4 max-w-2xl mx-auto">
                    {{ "This feature turns every run into a reflective letter - like a journal that writes itself. Once your activities sync from Strava, AI-generated letters will appear here automatically."|trans }}
                </p>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 max-w-2xl mx-auto text-left">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong class="font-medium">{{ "Getting started:"|trans }}</strong><br>
                                {{ "Letters will generate automatically when Strava syncs your runs (daily at 2pm). To generate letters for your past runs, contact your developer about running the backfill command."|trans }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <script>
    function editLetter(activityId) {
        const container = document.querySelector('.letter-content-' + activityId);
        const letterTextEl = container.querySelector('.letter-text');
        const currentText = letterTextEl.textContent;

        // Replace with textarea
        const textarea = document.createElement('textarea');
        textarea.className = 'w-full p-3 border border-gray-300 rounded-md focus:ring-strava-orange focus:border-strava-orange';
        textarea.rows = 4;
        textarea.value = currentText;

        container.innerHTML = '';
        container.classList.remove('italic', 'border-l-4', 'border-gray-300', 'pl-4');
        container.appendChild(textarea);

        // Add save/cancel buttons
        const actions = document.createElement('div');
        actions.className = 'flex gap-x-2 mt-2';
        actions.innerHTML = `
            <button onclick="saveLetter('${activityId}', this)"
                    class="px-4 py-2 text-sm font-medium text-white bg-strava-orange rounded-md hover:bg-orange-600">
                Save
            </button>
            <button onclick="cancelEdit('${activityId}', '${currentText.replace(/'/g, "\\'")}')"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                Cancel
            </button>
        `;
        container.after(actions);

        textarea.focus();
    }

    function saveLetter(activityId, button) {
        const container = document.querySelector('.letter-content-' + activityId);
        const textarea = container.querySelector('textarea');
        const newText = textarea.value;

        button.disabled = true;
        button.textContent = 'Saving...';

        fetch('/api/run-letter/' + activityId + '/edit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: newText})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                restoreLetterDisplay(activityId, data.text);
                container.nextElementSibling.remove(); // Remove action buttons
            }
        })
        .catch(e => {
            alert('Failed to save letter');
            button.disabled = false;
            button.textContent = 'Save';
        });
    }

    function cancelEdit(activityId, originalText) {
        restoreLetterDisplay(activityId, originalText);
        document.querySelector('.letter-content-' + activityId).nextElementSibling.remove();
    }

    function restoreLetterDisplay(activityId, text) {
        const container = document.querySelector('.letter-content-' + activityId);
        container.className = 'letter-content-' + activityId + ' text-base text-gray-700 leading-relaxed italic border-l-4 border-gray-300 pl-4';
        container.innerHTML = '"<span class="letter-text">' + text + '</span>"';
    }

    function togglePublic(activityId) {
        const button = document.querySelector('.public-toggle-' + activityId);
        button.disabled = true;

        fetch('/api/run-letter/' + activityId + '/toggle-public', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Reload page to update UI
                window.location.reload();
            }
        })
        .catch(e => {
            alert('Failed to update visibility');
            button.disabled = false;
        });
    }

    function copyShareLink(token) {
        const url = window.location.origin + '/letter/' + token;
        navigator.clipboard.writeText(url).then(() => {
            alert('Share link copied to clipboard!');
        });
    }
    </script>
{% endblock %}
