{% autoescape false %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>QT.run</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="theme-color" content="#F26822">
    <meta name="mobile-web-app-title" content="{{ "Statistics for Strava"|trans }}">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/jpeg" href="{{ relativeUrl('assets/images/logo.jpg') }}">
    <link href="{{ relativeUrl(asset('css/dist/tailwind.min.css')) }}" rel="stylesheet"/>
</head>
<body class="bg-gray-50 h-screen flex justify-center items-center">
{% include 'html/navigation/top-nav-bar.html.twig' %}
<div class="max-w-3xl mx-auto px-4">
    <div class="flex justify-between items-center pb-5">
        <p class="text-2xl font-semibold">Looks like you still need to import your Strava data</p>
        <button id="clear-cache-btn"
                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-green text-sm font-medium rounded-lg transition-colors">
            Clear Cache
        </button>
    </div>

    <dl class="text-gray-900 divide-y divide-gray-200">
        <div class="flex flex-col pb-6">
            <dt class="mb-2 text-gray-500 md:text-lg font-medium">Import Strava data</dt>
            <dd class="mb-3 font-semibold text-sm text-gray-600"><code>docker compose exec app bin/console app:strava:import-data</code></dd>
            <div class="flex items-center gap-3">
                <button id="import-btn"
                        class="px-6 py-2.5 bg-orange-500 hover:bg-orange-600 text-green font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Run Imports
                </button>
                <div id="import-status" class="text-sm font-medium"></div>
            </div>
            <div id="import-output" class="mt-3 hidden p-4 bg-gray-100 rounded-lg text-sm font-mono max-h-48 overflow-auto"></div>
        </div>
        <div class="flex flex-col py-6">
            <dt class="mb-2 text-gray-500 md:text-lg font-medium">Build static HTML files</dt>
            <dd class="mb-3 font-semibold text-sm text-gray-600"><code>docker compose exec app bin/console app:strava:build-files</code></dd>
            <div class="flex items-center gap-3">
                <button id="build-btn"
                        class="px-6 py-2.5 bg-orange-500 hover:bg-orange-600 text-green font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Run Build
                </button>
                <div id="build-status" class="text-sm font-medium"></div>
            </div>
            <div id="build-output" class="mt-3 hidden p-4 bg-gray-100 rounded-lg text-sm font-mono max-h-48 overflow-auto"></div>
            <div class="mt-4 flex w-full p-4 text-sm text-yellow-800 border border-yellow-300 rounded-lg bg-yellow-50"
                 role="alert">
                <svg class="shrink-0 inline w-4 h-4 me-3 mt-[2px]" aria-hidden="true"
                     xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
                </svg>
                <span class="sr-only">Info</span>
                <div>
                    You can only build these files if at least one Strava activity has been imported
                </div>
            </div>
        </div>
    </dl>

    <script>
        async function runCommand(endpoint, btnId, statusId, outputId) {
            const btn = document.getElementById(btnId);
            const status = document.getElementById(statusId);
            const output = document.getElementById(outputId);

            btn.disabled = true;
            status.textContent = 'Running...';
            status.className = 'text-sm font-medium text-blue-600';
            output.classList.add('hidden');

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();

                if (data.success) {
                    status.textContent = '✓ ' + data.message;
                    status.className = 'text-sm font-medium text-green-600';

                    if (data.output) {
                        output.textContent = data.output;
                        output.classList.remove('hidden');
                    }

                    // Reload page after successful build
                    if (endpoint.includes('/build')) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                } else {
                    status.textContent = '✗ ' + data.message;
                    status.className = 'text-sm font-medium text-red-600';

                    if (data.output || data.error) {
                        output.textContent = data.output || data.error;
                        output.classList.remove('hidden');
                    }
                }
            } catch (error) {
                status.textContent = '✗ Error: ' + error.message;
                status.className = 'text-sm font-medium text-red-600';
            } finally {
                btn.disabled = false;
            }
        }

        document.getElementById('import-btn').addEventListener('click', () => {
            runCommand('/api/setup/import', 'import-btn', 'import-status', 'import-output');
        });

        document.getElementById('build-btn').addEventListener('click', () => {
            runCommand('/api/setup/build', 'build-btn', 'build-status', 'build-output');
        });

        document.getElementById('clear-cache-btn').addEventListener('click', async () => {
            const btn = document.getElementById('clear-cache-btn');
            btn.disabled = true;
            btn.textContent = 'Clearing...';

            try {
                const response = await fetch('/api/setup/clear-cache', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    btn.textContent = 'Cache Cleared!';
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    btn.textContent = 'Failed';
                    setTimeout(() => {
                        btn.textContent = 'Clear Cache';
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                btn.textContent = 'Error';
                setTimeout(() => {
                    btn.textContent = 'Clear Cache';
                    btn.disabled = false;
                }, 2000);
            }
        });
    </script>
</div>
</body>
</html>
{% endautoescape %}